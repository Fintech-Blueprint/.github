# Branch Protection Runbook\n\nThis runbook provides exact `gh` CLI commands to apply branch protection to the `main` branch across all organization repositories.\n\nNotes before running:\n- You must run these commands as an org admin with `repo` and `admin:org` scopes and `gh` CLI authenticated to an account that has those privileges.\n- The commands assume the `gh` CLI is installed and authenticated (`gh auth login`).\n- These commands set required status checks. If a repository doesn't yet publish a status-check with the exact name, the CLI will fail — run the command after the CI has executed at least once to register the checks, or adjust the `--required-checks` value accordingly.\n\n# Replaceable variables\norg=Fintech-Blueprint\nrepos=(infra platform-libs contracts concierge db-manager api-gateway catalog design-system example-service .github staging-env)\n\n# Apply protection per-repo (copy & paste block):\n\nfor repo in \"${repos[@]}\"; do\n  echo \"Applying branch protection to $repo\"\n  gh api --method PUT /repos/$org/$repo/branches/main/protection -F required_status_checks='{\"strict\":true,\"contexts\":[\"unit\",\"contract\",\"lint\",\"sast\",\"sbom-sign\"]}' -F enforce_admins=true -F required_pull_request_reviews='{\"dismiss_stale_reviews\":true,\"require_code_owner_reviews\":true,\"required_approving_review_count\":1}' -F restrictions=null\n  gh api --method PUT /repos/$org/$repo/branches/main/protection -f required_linear_history=true -f allow_force_pushes=false -f allow_deletions=false || true\ndone\n\n# Explanation\n- `required_status_checks.strict=true`: Ensures status checks are up-to-date before merging.\n- `contexts`: status check names to require (`unit`, `contract`, `lint`, `sast`, `sbom-sign`) — adjust to match actual workflow check names if they differ.\n- `enforce_admins=true`: Enforces protections for admins as well.\n- `required_pull_request_reviews`: Requires one approving review and code-owner reviews.\n- `required_linear_history=true`: Enforces linear history.\n- `allow_force_pushes=false` & `allow_deletions=false`: Blocks force pushes and deletion of the `main` branch.\n\n# Troubleshooting\n- If you receive an HTTP 422 error about unknown `contexts`, run CI once to register check names, then re-run.\n- If your organization plan restricts branch protection, you'll see an error; apply protections manually via the web UI or upgrade the plan.\n\n# One-shot single-line command (for automation)\n\nprintf '%s\\n' \"${repos[@]}\" | xargs -I{} -n1 -P0 gh api --method PUT /repos/$org/{}/branches/main/protection -F required_status_checks='{\\\"strict\\\":true,\\\"contexts\\\":[\\\"unit\\\",\\\"contract\\\",\\\"lint\\\",\\\"sast\\\",\\\"sbom-sign\\\"]}' -F enforce_admins=true -F required_pull_request_reviews='{\\\"dismiss_stale_reviews\\\":true,\\\"require_code_owner_reviews\\\":true,\\\"required_approving_review_count\\\":1}' -F required_linear_history=true -F allow_force_pushes=false -F allow_deletions=false || true\n
